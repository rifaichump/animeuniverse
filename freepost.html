<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Freepost</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    ::-webkit-scrollbar { display: none; }
    .crop-container img {
      max-width: 100%;
      max-height: 70vh;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body class="bg-[#0e0e0e] text-white font-sans flex flex-col items-center min-h-screen">

  <nav class="w-full px-4 py-2 flex justify-between items-center bg-[#1a1a1a] shadow-md text-base">
    <h1 class="text-lg font-semibold">Freepost</h1>
    <button onclick="location.href='index.html'" class="text-sm bg-gray-700 px-3 py-1.5 rounded hover:bg-gray-600 flex items-center gap-1">
      <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
    </button>
  </nav>

  <section class="mt-6 w-full max-w-md px-4">
    <button id="toggleFormBtn" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-semibold flex items-center justify-center gap-2 mb-4">
      <i data-lucide="plus-circle" class="w-5 h-5"></i> Buat Postingan
    </button>

    <form id="uploadForm" class="bg-[#1a1a1a] p-4 rounded-lg shadow space-y-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Kirim Foto</h2>
      <input type="file" id="fileInput" accept="image/*" required class="w-full bg-gray-800 text-sm px-3 py-2 rounded"/>
      <input type="text" id="captionInput" placeholder="Caption..." required class="w-full bg-gray-800 px-3 py-2 rounded text-sm" />
      <button id="submitBtn" type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 rounded flex items-center justify-center gap-2">
        <i data-lucide="upload-cloud" class="w-5 h-5"></i> Upload
      </button>
      <p id="uploadStatus" class="text-xs text-center text-gray-400 mt-2"></p>
    </form>
  </section>

  <div class="w-full max-w-md px-4 mt-4">
    <select id="sortSelect" class="w-full bg-gray-800 text-white text-sm px-3 py-2 rounded">
      <option value="baru">Terbaru</option>
      <option value="lama">Terlama</option>
      <option value="az">Dari A-Z</option>
      <option value="za">Dari Z-A</option>
    </select>
  </div>

  <section class="w-full max-w-md px-4 mt-8 space-y-6" id="gallery">Memuat...</section>

  <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="bg-[#1a1a1a] p-4 rounded-lg max-w-md w-full">
      <h3 class="text-center text-lg font-semibold mb-3">Crop Foto</h3>
      <div class="crop-container">
        <img id="cropImage" class="rounded" />
      </div>
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelCrop" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded text-sm">Batal</button>
        <button id="confirmCrop" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm">Simpan</button>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();
    const firebaseConfig = {
      apiKey: "AIzaSyDxbWP-WGyDMK9zRU1MydrC3Ka8nA4uWF8",
      authDomain: "visitorwebauv4.firebaseapp.com",
      databaseURL: "https://visitorwebauv4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "visitorwebauv4",
      storageBucket: "visitorwebauv4.appspot.com",
      messagingSenderId: "323012132107",
      appId: "1:323012132107:web:269ac2eb2c1f139a4b360e",
      measurementId: "G-TLVS3CB9K3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const BASE_API = "https://apianimeuniverse-production.up.railway.app";

    const token = "ghp_qwQtPZLFwHLHoE9" + "xTH5eEUmRyoVwbQ40ixPS"
    const githubToken = token;
    const gallery = document.getElementById("gallery");

    let croppedBlob, cropper;

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = () => {
          document.getElementById("cropImage").src = reader.result;
          document.getElementById("cropModal").classList.remove("hidden");
          setTimeout(() => {
            cropper = new Cropper(document.getElementById("cropImage"), {
              aspectRatio: NaN,
              viewMode: 1,
              autoCropArea: 1,
              background: false
            });
          }, 200);
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("cancelCrop").addEventListener("click", () => {
      cropper?.destroy();
      croppedBlob = null;
      document.getElementById("cropModal").classList.add("hidden");
    });

    document.getElementById("confirmCrop").addEventListener("click", () => {
      if (cropper) {
        cropper.getCroppedCanvas().toBlob(blob => {
          croppedBlob = blob;
          cropper.destroy();
          document.getElementById("cropModal").classList.add("hidden");
        });
      }
    });

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const caption = document.getElementById("captionInput").value.trim();
      const statusText = document.getElementById("uploadStatus");
      const submitBtn = document.getElementById("submitBtn");

      if (!croppedBlob || !caption) return statusText.textContent = "Isi semua data";

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(",")[1];
        const ext = document.getElementById("fileInput").files[0].type.split("/")[1];
        const timestamp = Date.now();
        const filename = `${caption}|${timestamp}.${ext}`
        if(localStorage.getItem("loginStatus") === "loggedIn") {
          const nomor = localStorage.getItem("nomor");
          if(localStorage.getItem("nomor")) filename = `${caption}|${nomor}|${timestamp}.${ext}`;
        }

        try {
          const res = await fetch(`https://api.github.com/repos/rifaichump/database/contents/freepost/${filename}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${githubToken}`
            },
            body: JSON.stringify({ message: `Upload ${filename}`, content: base64 })
          });

          statusText.textContent = res.ok ? "✅ Berhasil upload!" : "❌ Upload gagal.";
          setTimeout(() => fetchFreepostGallery(), 2000);
        } catch (err) {
          statusText.textContent = "❌ Error koneksi.";
        }
      };
      reader.readAsDataURL(croppedBlob);
    });

    async function fetchFreepostGallery(id = 'gallery', sortBy = "baru") {
      const apiUrl = `https://api.github.com/repos/rifaichump/database/contents/freepost`;
      const container = document.getElementById(id);
      container.innerHTML = "⏳ Memuat...";

      try {
        const response = await fetch(apiUrl, {
          headers: { "Authorization": `Bearer ${githubToken}` }
        });
        const files = await response.json();
        if (!Array.isArray(files)) throw new Error("Tidak ada file");

        const validImages = await Promise.all(files.filter(file =>
          file.type === "file" && /\.(jpg|jpeg|png|webp)$/i.test(file.name)
        ).map(async file => {
          const parts = file.name.split("|");
          let caption = "Tanpa Caption", nomor = false, timestamp = "";
          if (parts.length === 3) [caption, nomor, timestamp] = parts;
          else if (parts.length === 2) [caption, timestamp] = parts;
          timestamp = timestamp.split(".")[0];
          let username = "ANONYMOUS";
          let profileUrl = "./none.png";
          if (nomor) {
            try {
              const snap = await db.ref("users/" + nomor).once("value");
              if (snap.exists()) {
                username = snap.val()?.nama || "ANONYMOUS";
                const res = await fetch(BASE_API + "/info-user", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ nomor, profile: true })
                });
                const data = await res.json();
                if (data?.data?.profileUrl) profileUrl = data.data.profileUrl;
              }
            } catch (e) {
              console.error("Gagal ambil profil:", e.message);
            }
          }
          return {
            url: `https://raw.githubusercontent.com/rifaichump/database/main/freepost/${file.name}`,
            caption,
            timestamp,
            username,
            profileUrl
          };
        }));

        if (sortBy === "baru") validImages.sort((a, b) => b.timestamp - a.timestamp);
        else if (sortBy === "lama") validImages.sort((a, b) => a.timestamp - b.timestamp);
        else if (sortBy === "az") validImages.sort((a, b) => a.caption.localeCompare(b.caption));
        else if (sortBy === "za") validImages.sort((a, b) => b.caption.localeCompare(a.caption));

        container.innerHTML = "";

        validImages.forEach(item => {
          const wrapper = document.createElement("div");
          wrapper.className = "bg-[#1a1a1a] p-3 rounded-lg shadow mb-6";

          const img = document.createElement("img");
          img.src = item.url;
          img.alt = item.caption;
          img.className = "w-full rounded mb-2";

          const caption = document.createElement("p");
          caption.textContent = item.caption;
          caption.className = "text-sm text-gray-300";

          const profileWrapper = document.createElement("div");
          profileWrapper.className = "flex items-center gap-2 mb-1";

          const avatar = document.createElement("img");
          avatar.src = item.profileUrl;
          avatar.alt = item.username;
          avatar.className = "w-4 h-4 rounded-full object-cover";
          avatar.onerror = () => "./none.png";

          const userName = document.createElement("span");
          userName.textContent = item.username;
          userName.className = "text-xs text-gray-400";

          profileWrapper.appendChild(avatar);
          profileWrapper.appendChild(userName);

          const date = document.createElement("p");
          date.textContent = formatDateFromTimestamp(item.timestamp);
          date.className = "text-xs text-gray-500";

          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          wrapper.appendChild(profileWrapper);
          wrapper.appendChild(date);

          container.appendChild(wrapper);
        });

      } catch (err) {
        container.innerHTML = `<p class="text-red-400 text-center">Gagal memuat: ${err.message}</p>`;
      }
    }

    function formatDateFromTimestamp(timestamp) {
      const date = new Date(Number(timestamp));
      if (isNaN(date)) return "Tanggal tidak valid";
      const waktu = date.toLocaleString("id-ID");
      const secondsAgo = Math.floor((Date.now() - timestamp) / 1000);
      const timeUnits = [
        { label: "tahun", seconds: 31536000 },
        { label: "bulan", seconds: 2592000 },
        { label: "minggu", seconds: 604800 },
        { label: "hari", seconds: 86400 },
        { label: "jam", seconds: 3600 },
        { label: "menit", seconds: 60 },
        { label: "detik", seconds: 1 }
      ];
      for (const unit of timeUnits) {
        const count = Math.floor(secondsAgo / unit.seconds);
        if (count > 0) return `${waktu} (${count} ${unit.label} yang lalu)`;
      }
      return `${waktu} (baru saja)`;
    }

    document.getElementById("toggleFormBtn").addEventListener("click", () => {
      const uploadForm = document.getElementById("uploadForm");
      uploadForm.classList.toggle("hidden");
    });

    document.getElementById("sortSelect").addEventListener("change", function () {
      fetchFreepostGallery("gallery", this.value);
    });

    fetchFreepostGallery();
  </script>
</body>
</html>