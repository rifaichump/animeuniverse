<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil Saya</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    @keyframes borderColorChange {
      0% { border-color: #3b82f6; }
      25% { border-color: #10b981; }
      50% { border-color: #f59e0b; }
      75% { border-color: #ef4444; }
      100% { border-color: #3b82f6; }
    }
    .animated-border {
      animation: borderColorChange 5s infinite;
    }
  </style>
</head>
<body class="bg-[#0e0e0e] text-white min-h-screen flex items-center justify-center p-4">

  <div id="loadingScreen" class="absolute inset-0 bg-[#0e0e0e] flex flex-col items-center justify-center z-50">
    <svg class="animate-spin h-10 w-10 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <p class="text-sm text-gray-300">Memuat profil...</p>
  </div>

  <div id="profilContainer" class="bg-[#1a1a1a] p-6 rounded-xl shadow-lg w-full max-w-sm space-y-6 container-profil hidden">
    <h1 class="text-xl font-bold text-center flex items-center justify-center gap-2">
      <i data-lucide="user" class="w-6 h-6"></i> Profil Saya
    </h1>

    <div class="flex justify-center">
      <img id="fotoProfil" src="./none.png" class="w-24 h-24 rounded-full border-2 animated-border" />
    </div>

    <div class="space-y-2">
      <p><strong>Nomor:</strong> <span id="userNomor">...</span></p>
      <p><strong>Nama:</strong> <span id="userNama">...</span></p>
    </div>

    <div class="border-t border-gray-700 pt-4 space-y-2">
      <p><strong>Uang:</strong> <span id="userUang">RP...</span></p>
      <p><strong>Koin:</strong> <span id="userKoin">...</span></p>
      <p><strong>Limit:</strong> <span id="userLimit">...</span></p>
    </div>

    <button id="toggleFormBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-1.5 rounded text-xs font-normal flex items-center justify-center gap-2">
      <i data-lucide="edit-3" class="w-4 h-4"></i> Ganti Nama
    </button>

    <div id="formGantiNama" class="space-y-2 hidden">
      <input type="text" id="newNamaInput" placeholder="Nama baru" class="w-full bg-gray-800 px-3 py-1.5 rounded text-sm" />
      <input type="password" id="verifPassword" placeholder="Password akun" class="w-full bg-gray-800 px-3 py-1.5 rounded text-sm" />
      <button id="updateBtn" class="w-full bg-green-600 hover:bg-green-500 py-1.5 rounded text-xs font-normal flex items-center justify-center gap-2">
        <i data-lucide="check" class="w-4 h-4"></i> Konfirmasi
      </button>
    </div>

    <button onclick="window.location.href='index.html'" class="w-full bg-gray-700 hover:bg-gray-600 py-1.5 rounded text-xs font-normal flex items-center justify-center gap-2">
      <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
    </button>

    <p id="statusMessage" class="text-sm text-center hidden mt-2"></p>
  </div>

  <script>
    localStorage.removeItem("username");

    const firebaseConfig = {
      apiKey: "AIzaSyDxbWP-WGyDMK9zRU1MydrC3Ka8nA4uWF8",
      authDomain: "visitorwebauv4.firebaseapp.com",
      databaseURL: "https://visitorwebauv4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "visitorwebauv4",
      storageBucket: "visitorwebauv4.appspot.com",
      messagingSenderId: "323012132107",
      appId: "1:323012132107:web:269ac2eb2c1f139a4b360e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const BASE_API = "https://apianimeuniverse-production.up.railway.app";

    const userNomor = localStorage.getItem("nomor");
    const userRef = db.ref("users/" + userNomor);

    const userNomorSpan = document.getElementById("userNomor");
    const userNamaSpan = document.getElementById("userNama");
    const userUangSpan = document.getElementById("userUang");
    const userKoinSpan = document.getElementById("userKoin");
    const userLimitSpan = document.getElementById("userLimit");
    const fotoProfil = document.getElementById("fotoProfil");
    const newNamaInput = document.getElementById("newNamaInput");
    const verifPassword = document.getElementById("verifPassword");
    const updateBtn = document.getElementById("updateBtn");
    const statusMessage = document.getElementById("statusMessage");
    const formGantiNama = document.getElementById("formGantiNama");
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const loadingScreen = document.getElementById("loadingScreen");
    const profilContainer = document.getElementById("profilContainer");

    if (!userNomor || localStorage.getItem("loginStatus") !== "loggedIn") {
      window.location.href = "login.html";
    }

    fetch(BASE_API + "/info-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nomor: userNomor })
    })
    .then(res => res.json())
    .then(res => {
      if (res.status && res.data) {
        const { profileUrl, money, coin, limit } = res.data;

        userRef.once("value").then(snap => {
          if (!snap.exists()) {
            tampilkanStatus("Akun tidak ditemukan.", "red");
            window.location.href = "login.html";
            return;
          }

          if (profileUrl) fotoProfil.src = profileUrl;
          userNomorSpan.textContent = userNomor;
          userNamaSpan.textContent = snap.val().nama;
          userUangSpan.textContent = "Rp" + (money ?? 0).toLocaleString();
          userKoinSpan.textContent = coin ?? 0;
          userLimitSpan.textContent = limit ?? 0;

          loadingScreen.classList.add("hidden");
          profilContainer.classList.remove("hidden");
        });

        if (money === undefined && coin === undefined && limit === undefined) {
          tampilkanStatus("Nomor kamu tidak terdaftar di bot kami.", "yellow");
        }
      } else {
        tampilkanStatus("Gagal mengambil data.", "red");
      }
    })
    .catch(() => tampilkanStatus("Koneksi ke server gagal.", "red"));

    let formTerbuka = false;
    toggleFormBtn.addEventListener("click", () => {
      formTerbuka = !formTerbuka;
      formGantiNama.classList.toggle("hidden");
      toggleFormBtn.innerHTML = formTerbuka
        ? `<i data-lucide="x" class="w-4 h-4"></i> Batalkan`
        : `<i data-lucide="edit-3" class="w-4 h-4"></i> Ganti Nama`;
      lucide.createIcons();
    });

    updateBtn.addEventListener("click", async () => {
      const namaBaru = newNamaInput.value.trim();
      const passwordInput = verifPassword.value.trim();

      const snap = await userRef.once("value");

      if (!namaBaru || !passwordInput) {
        tampilkanStatus("Semua input wajib diisi.", "red");
        return;
      }

      const data = snap.val();
      if (data.password !== passwordInput) {
        tampilkanStatus("Password salah.", "red");
        return;
      }

      const allUsersSnap = await db.ref("users").once("value");
      let alreadyName = false;

      allUsersSnap.forEach((childSnap) => {
        const nomor = childSnap.key;
        const user = childSnap.val();
        if (user.nama && user.nama.toLowerCase() === namaBaru.toLowerCase()) {
          alreadyName = true;
        }
      });

      if (alreadyName) {
        tampilkanStatus("Username sudah digunakan.", "red");
        return;
      }

      userRef.update({ nama: namaBaru }, () => {
        fetch(BASE_API + "/send-message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            jid: "120363043559522563@g.us",
            msg: {
              text: `âœ… *Web Notification*\n\n@${userNomor} Mengganti username dari _${userNamaSpan.textContent}_ menjadi _${namaBaru}_.`,
              mentions: [userNomor + "@s.whatsapp.net"]
            }
          })
        });

        userNamaSpan.textContent = namaBaru;
        newNamaInput.value = "";
        verifPassword.value = "";
        tampilkanStatus("Nama berhasil diperbarui.", "green");

        formGantiNama.classList.add("hidden");
        toggleFormBtn.innerHTML = `<i data-lucide="edit-3" class="w-4 h-4"></i> Ganti Nama`;
        formTerbuka = false;
        lucide.createIcons();
      });
    });

    function tampilkanStatus(pesan, warna) {
      statusMessage.textContent = pesan;
      statusMessage.className = `text-sm text-center mt-2 text-${warna}-400`;
      statusMessage.classList.remove("hidden");
      setTimeout(() => statusMessage.classList.add("hidden"), 4000);
    }

    lucide.createIcons();
  </script>
</body>
</html>
