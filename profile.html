<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil Saya</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @keyframes borderColorChange {
      0% { border-color: #3b82f6; }
      25% { border-color: #10b981; }
      50% { border-color: #f59e0b; }
      75% { border-color: #ef4444; }
      100% { border-color: #3b82f6; }
    }

    .animated-border {
      animation: borderColorChange 5s infinite;
    }
  </style>
</head>
<body class="bg-[#0e0e0e] text-white min-h-screen flex items-center justify-center p-4">
  <div class="bg-[#1a1a1a] p-6 rounded-xl shadow-lg w-full max-w-sm space-y-6">
    <h1 class="text-xl font-bold text-center flex items-center justify-center gap-2">
      <i data-lucide="user" class="w-6 h-6"></i> Profil Saya
    </h1>

    <div class="flex justify-center">
      <img
        id="fotoProfil"
        alt="Foto Profil"
        class="w-24 h-24 rounded-full border-4 animated-border"
      />
    </div>

    <div class="space-y-2">
      <p><strong>Nomor:</strong> <span id="userNomor"></span></p>
      <p><strong>Nama:</strong> <span id="userNama"></span></p>
    </div>

    <div class="border-t border-gray-700 pt-4 space-y-2">
      <p><strong>Uang:</strong> <span id="userUang">Rp0</span></p>
      <p><strong>Koin:</strong> <span id="userKoin">0</span></p>
      <p><strong>Limit:</strong> <span id="userLimit">0</span></p>
    </div>

    <button id="toggleFormBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-1.5 rounded text-xs font-normal flex items-center justify-center gap-2">
      <i data-lucide="edit-3" class="w-4 h-4"></i> Ganti Nama
    </button>

    <div id="formGantiNama" class="space-y-2 hidden">
      <input type="text" id="newNamaInput" placeholder="Nama baru" class="w-full bg-gray-800 px-3 py-1.5 rounded text-sm" />
      <input type="password" id="verifPassword" placeholder="Password akun" class="w-full bg-gray-800 px-3 py-1.5 rounded text-sm" />
      <button id="updateBtn" class="w-full bg-green-600 hover:bg-green-500 py-1.5 rounded text-xs font-normal flex items-center justify-center gap-2">
        <i data-lucide="check" class="w-4 h-4"></i> Konfirmasi
      </button>
    </div>

    <button onclick="window.location.href='index.html'" class="w-full bg-gray-700 hover:bg-gray-600 py-1.5 rounded text-xs font-normal flex items-center justify-center gap-2">
      <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
    </button>

    <p id="statusMessage" class="text-sm text-center hidden mt-2"></p>
  </div>

  <script>
    const userNomor = localStorage.getItem("nomor");
    const userNama = localStorage.getItem("username");

    const userNomorSpan = document.getElementById("userNomor");
    const userNamaSpan = document.getElementById("userNama");
    const userUangSpan = document.getElementById("userUang");
    const userKoinSpan = document.getElementById("userKoin");
    const userLimitSpan = document.getElementById("userLimit");
    const fotoProfil = document.getElementById("fotoProfil");

    const newNamaInput = document.getElementById("newNamaInput");
    const verifPassword = document.getElementById("verifPassword");
    const updateBtn = document.getElementById("updateBtn");
    const statusMessage = document.getElementById("statusMessage");
    const formGantiNama = document.getElementById("formGantiNama");
    const toggleFormBtn = document.getElementById("toggleFormBtn");

    if (!userNomor || !userNama || localStorage.getItem("loginStatus") !== "loggedIn") {
      window.location.href = "login.html";
    }

    userNomorSpan.textContent = userNomor;
    userNamaSpan.textContent = userNama;

    fetch("https://apianimeuniverse-production.up.railway.app/info-user", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ nomor: userNomor })
    })
    .then(res => res.json())
    .then(res => {
      console.log(res.data);
      if (res.status && res.data) {
        const { profileUrl, money, coin, limit } = res.data;

        if (profileUrl) {
          fotoProfil.src = profileUrl;
        }

        const uang = money ?? 0;
        const koin = coin ?? 0;
        const batas = limit ?? 0;

        userUangSpan.textContent = "Rp" + uang.toLocaleString();
        userKoinSpan.textContent = koin;
        userLimitSpan.textContent = batas;

        if (money === undefined && coin === undefined && limit === undefined) {
          tampilkanStatus("Nomor kamu tidak terdaftar di bot kami.", "yellow");
        }
      } else {
        tampilkanStatus("Gagal mengambil data.", "red");
      }
    })
    .catch(err => {
      console.error("Fetch error:", err);
      tampilkanStatus("Koneksi ke server gagal.", "red");
    });

    let formTerbuka = false;

    toggleFormBtn.addEventListener("click", () => {
      formTerbuka = !formTerbuka;
      formGantiNama.classList.toggle("hidden");

      toggleFormBtn.innerHTML = formTerbuka
        ? `<i data-lucide="x" class="w-4 h-4"></i> Batalkan`
        : `<i data-lucide="edit-3" class="w-4 h-4"></i> Ganti Nama`;

      lucide.createIcons();
    });

    updateBtn.addEventListener("click", () => {
      const namaBaru = newNamaInput.value.trim();
      const passwordInput = verifPassword.value.trim();

      if (!namaBaru || !passwordInput) {
        tampilkanStatus("Semua input wajib diisi.", "red");
        return;
      }

      localStorage.setItem("username", namaBaru);
      userNamaSpan.textContent = namaBaru;
      newNamaInput.value = "";
      verifPassword.value = "";
      tampilkanStatus("Nama berhasil diperbarui.", "green");
      formGantiNama.classList.add("hidden");
      toggleFormBtn.innerHTML = `<i data-lucide="edit-3" class="w-4 h-4"></i> Ganti Nama`;
      formTerbuka = false;
      lucide.createIcons();
    });

    function tampilkanStatus(pesan, warna) {
      statusMessage.textContent = pesan;
      statusMessage.className = `text-sm text-center mt-2 text-${warna}-400`;
      statusMessage.classList.remove("hidden");
      setTimeout(() => statusMessage.classList.add("hidden"), 4000);
    }

    lucide.createIcons();
  </script>
</body>
</html>
